name: DOWS6027 Automation

on:
  workflow_dispatch: # manual trigger
  schedule:
    # Run daily at 00:00 UTC — workflow will exit early unless it's the last day of the month.
    - cron: '0 0 * * *'

env:
  DOWS_RUN_MODE: monthly

jobs:
  run_dows6027:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Ensure this is the last day of the month (UTC) — exit 0 silently if not
        id: lastday
        run: |
          TODAY_UTC=$(date -u +%d)
          LAST_UTC=$(date -u -d "$(date -u +%Y-%m-1) +1 month -1 day" +%d)

          if [ "$TODAY_UTC" != "$LAST_UTC" ]; then
            exit 0
          fi

      - name: Run DOWS6027 automation
        run: node dows6027.js
        env:
          DOWS_RUN_MODE: ${{ env.DOWS_RUN_MODE }}
